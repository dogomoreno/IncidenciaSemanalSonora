# Paquetes
library(tidyverse)
library(lubridate)
library(extrafont)
library(scales)
library(showtext)
library(Cairo)
library(rcartocolor)
library(rgdal)
library(rgeos)



# Descarga de proyección de población del Consejo Nacional de Población 2015-2030

pob.url <- "http://www.conapo.gob.mx/work/models/CONAPO/Datos_Abiertos/Proyecciones2018/base_municipios_final_datos_02.rar"
pob.archivo <- "./Descargas/pob.rar"

download.file(pob.url, destfile = pob.archivo, quiet = TRUE, mode = "wb")

z7path = shQuote('C:\\Program Files\\7-Zip\\7z')
file = paste(getwd(), '/Descargas/pob.rar', sep = '')
dest = paste(getwd(), '/Bases', sep = '')
cmd = paste(z7path, ' e ', file, ' -ir!*.* -o', '"', dest, '"', sep='')
system(cmd)

POB <- read_csv("Bases/base_municipios_final_datos_02.csv", 
                col_types = cols(RENGLON = col_character(), 
                                 CLAVE = col_character(), CLAVE_ENT = col_character()), 
                locale = locale(encoding = "ISO-8859-1"))

# Descarga de la serie de tiempo de casos acumulados por día de los municipios de Sonora del repositorio https://github.com/dogomoreno/Covid19-Sonora-Municipios

Casos.url <- "https://raw.githubusercontent.com/dogomoreno/Covid19-Sonora-Municipios/master/Bases/ST_CasosMunicipalesSonora.csv"
Casos.archivo <- "./Bases/ST_CasosMunicipalesSonora.csv"

download.file(Casos.url, destfile = Casos.archivo)

Casosdiarios <- read_csv("Bases/ST_CasosMunicipalesSonora.csv",
                         col_types = cols(CVE_MUN = col_character()),
                         locale = locale(encoding = "ISO-8859-1"))

# Se obtienen las Regiones de Sonora del archivo https://github.com/dogomoreno/Covid19-Sonora-Municipios el cual toma la regionalización de la Secretaría de la Contraloría General del Estado

Regiones.url <- "https://raw.githubusercontent.com/dogomoreno/Covid19-Sonora-Municipios/master/Bases/RegionesSonora.csv"
Regiones.archivo <- "./Bases/RegionesSonora.csv"

download.file(Regiones.url, destfile = Regiones.archivo)

RegionesSonora <- read_csv("Bases/RegionesSonora.csv",
                           col_types = cols(CVEGEO = col_character()),
                           locale = locale(encoding = "ISO-8859-1"))

# Se filtra el año y la entidad federativa objetivo, en este caso Sonora (CLAVE_ENT=26) y se agrupa por municipios obteniendo la suma de la población total

POBMUN <- POB %>% filter(CLAVE_ENT==26, AÑO==2020) %>% select(CLAVE, MUN, POB) %>%  group_by(CLAVE) %>% summarise(POB=sum(POB)) %>% rename(CVEGEO=CLAVE)


# Se obtienen los casos diarios por municipios en formato tidy

Casosdiarios[is.na(Casosdiarios)] <- 0
Casosdiarios<- Casosdiarios %>% 
  select( -POBLACIÓN) %>% 
  rename(CVEGEO=CVE_MUN, MUNICIPIO = NOM_MUN) %>% 
  gather( key= "Fecha", value= "CASOS", ends_with("2020")) %>%
  mutate(Fecha = as.Date(Fecha,format = "%d/%m/%Y")) %>% 
  group_by(MUNICIPIO, CVEGEO) %>% 
  mutate(NUEVOS= (CASOS - lag(CASOS, default = 0, order_by=Fecha)))%>% 
  select (Fecha, CVEGEO, MUNICIPIO, CASOS, NUEVOS)


# Se obtienen los casos semanales (tomando la semana lunes-domingo)

Casossemana <- Casosdiarios %>% mutate(SEMANA = isoweek(Fecha)) %>% group_by(SEMANA) %>% 
  mutate (REPORTE=max(as.Date(Fecha))) %>% ungroup()
Casossem <- group_by(Casossemana, CVEGEO, MUNICIPIO, REPORTE, SEMANA) %>% 
  summarise(CASOS_SEMANALES = sum(NUEVOS)) 

# Se une la tabla Casossemana con las de POBMUN y RegionesSonora, y reordenamos las columnas

casossempob <- Casossem %>% 
  left_join(POBMUN, by = "CVEGEO") %>% 
  left_join(RegionesSonora, by = "CVEGEO") %>% 
  select(SEMANA, REPORTE, CVEGEO, MUNICIPIO, CLAS_REG, POB, CASOS_SEMANALES)

#  Como resultado obtenemos una tabla en formato tidy, la cual salvamos en un extensión csv
write.csv(casossempob, 'ResultadoCSV/Casossemanales.csv')


# Se calcula la incidencia semanal de casos de covid por 100 mil habitantes en los municipios (Incidencia = (Casos/Población)*100,000)
casossempob  <- casossempob %>% mutate (INCIDENCIA= round((CASOS_SEMANALES*100000)/POB,1))
casossempob$INCIDENCIA[casossempob$INCIDENCIA==0] <- NA

# Se define clasificación de la incidencia semanal en términos cualitativos  en 5 clases, las cuales corresponden a los cuantiles de la incidencia de todas las semanas, de todos los municipios desde el primer contagio confirmado en Sonora de la siguiente manera: "Muy baja", "Baja", "Media", "Alta" y "Muy Alto"

# **Muy baja:** 0%-25%
  
#  **Baja:** 25%-50%
  
#  **Media:** 50%-75%
  
#  **Alta:** 75%-95%
  
#  **Muy alta:** >95%


# Se obtienen los cuantiles específicos para realizar la clasificación.

round(quantile(casossempob$INCIDENCIA, c(0.25, 0.5, 0.75, 0.95), na.rm=TRUE),0)

# Se realiza la clasificación creando la variable IS
casossempob   <- mutate(casossempob , IS=if_else(INCIDENCIA>160,5, if_else(INCIDENCIA>59,4, if_else(INCIDENCIA>30,3,if_else(INCIDENCIA>15,2,1)))))


# Se definen los elementos de formato del gráfico
discreta <- c("5" = "black", "4" = "#005155","3" = "#01787E","2" = "#01A2AC", "1" = "#58BCBC")

paragraf <- theme(plot.title = (element_text(family = "Lato Black", size = 32, color = "black")),
                  plot.subtitle = (element_text(family = "Lato Light", size = 12, color = "#01787E")),
                  legend.key.height = unit (1, "cm"), legend.position = "right",   
                  axis.text.y = element_text(family = "Lato Light", size = 15, color = "black"), 
                  axis.text.x = element_text(family = "Lato Light", size =9, color = "black"),
                  legend.text = element_text(family = "Lato", size = 8, color = "black"),
                  panel.background = element_rect(fill="gray97") ,
                  panel.grid.major.y = element_blank(),
                  panel.grid.major.x = element_blank(),
                  panel.grid.minor.y = element_blank(),
                  panel.grid.minor.x = element_blank(),
                  legend.title = element_text(family = "Lato Black", size = 8, color = "black"),
                  plot.caption = element_text(family = "Lato Light", size =10, color = "gray50"),
                  axis.title = element_text(family = "Lato", size = 12))
subtitulo <- "Incidencia semanal de casos de covid-19\nCorte al 05/12/2020 | Semana 49"
marcas <- c( "Muy alta", "Alta", "Media","Baja", "Muy baja")

# Aprovechando se se tiene una regionalización del los municipios se pueden realizar mapas de calor por región de la incidencia semanal en Sonora.

#Río Sonora
Region <- "Río Sonora"
casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")


# Sierra Alta
Region <- "Sierra Alta"
casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")

# Sierra Centro
Region <- "Sierra Centro"

casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")

#Sur
Region <- "Sur"
casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")


#Centro Norte
Region <- "Centro Norte"
casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")



#Noroeste
Region <- "Noroeste"
casossempobF  <- casossempob %>% filter(CLAS_REG==Region)

IncidenciaG <- ggplot(data = casossempobF) + 
  geom_tile(mapping = aes(x = SEMANA, y = reorder(MUNICIPIO, desc(MUNICIPIO)), fill = as.factor(IS)), color = "white", size=0.5) +
  scale_fill_manual("INCIDENCIA\n(casos por 100 mil habs.)", 
                    values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas)+
  scale_x_continuous(breaks = seq(from = 12, to = 49, by = 1))+
  theme_minimal() +
  labs(y = NULL, x = "Semana (lunes-domingo)", title  = paste("Región", Region), 
       subtitle = subtitulo,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora") +
  paragraf 

ggsave(paste("Gráficos/",Region,".png", sep = ""),IncidenciaG, bg = "white", height = 15, width = 30, units = "cm", dpi = 800, type = "cairo")

# Asimismo se puede obtener el mapa de incidencia semanal de una semana en específico
casossempob <-casossempob %>%  mutate(id=CVEGEO) %>% filter(SEMANA==49)

capa_munison <- readOGR("Shapes", layer="MUNSON")
capa_reg <- readOGR("Shapes", layer="REGSON")
capa_munison_df <- fortify(capa_munison, region="concat")
capa_munison_inci<- inner_join(capa_munison_df, casossempob, by="id") 

subtitulomapa <- "Casos de covid-19 por 100 mil habitantes\nCorte al 03/12/2020 | Semana 49"

Mapa_incidencia<- ggplot(capa_munison_inci, aes(map_id = id)) +
  geom_polygon(data=capa_munison, aes(x=long, y=lat, group=group), 
               fill="gray90", color="white", size=0.12) +
  geom_map(aes(fill = factor(IS)),color = "white",size=0.22, map = capa_munison_df) + 
  scale_fill_manual(values = discreta, 
                    breaks= c("5", "4", "3", "2", "1"), 
                    labels = marcas) +
  theme_void() +
  theme(plot.title = (element_text(family = "Lato Black", size = 20, color = "black")),
        plot.subtitle = (element_text(family = "Lato Light", size = 8, color = "#01787E")),
        plot.margin = margin(0.5, 0.5, 0.25, 0.4, "cm"),
        legend.position = "right",
        plot.background = element_rect(fill = "white", color="black", size=3),
        legend.key.height = unit (0.5, "cm"), legend.key.width = unit (0.2, "cm"), axis.text = element_blank(),
        legend.text = element_text(family = "Lato", size = 6, color = "black"),
        legend.title = element_text(family = "Lato Black", size = 5, color = "black"),
        plot.caption = element_text(family = "Lato Light", size = 6.5, color = "gray40"),
        axis.title = element_blank()) +
  labs(y = NULL, x = NULL, title  = "Incidencia semanal", 
       subtitle = subtitulomapa,  fill = NULL, 
       caption ="Elaboración Luis Armando Moreno con información de la Secretaría de Salud del Estado de Sonora")+
  geom_polygon(data=capa_reg, aes(x=long, y=lat, group=group), 
               fill="transparent", color="black", size=0.2)

ggsave("Gráficos/mincidencia.png",Mapa_incidencia, bg = "transparent", height = 12, width = 12, units = "cm", dpi = 800, type = 'cairo')

